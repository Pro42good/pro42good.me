<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>
    <style>
        /* Add styles later Mister Diego */
    </style>
</head>
<body>
    <h1>Login</h1>

    <section id="auth-section">
        <form id="email-form" autocomplete="on">
            <div>
                <label for="email">Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" autocapitalize="none" spellcheck="false" required />
            </div>
            <div>
                <label for="password">Password</label>
                <input id="password" name="password" type="password" autocomplete="current-password" minlength="6" required />
            </div>
            <div>
                <button id="emailSignInBtn" type="button">Sign In</button>
                <button id="emailSignUpBtn" type="button">Create Account</button>
            </div>
        </form>

        <div>
            <button id="googleSignInBtn" type="button">Sign In with Google</button>
        </div>

        <div>
            <button id="signOutBtn" type="button" hidden>Sign Out</button>
        </div>

        <div id="error" role="alert" aria-live="polite"></div>
    </section>

    <section id="post-login" hidden>
        <p>Logged in successfully, diego change this later to a custom function</p>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNAapu8kv9VUH_Eg983tSn-n3-umrO4Jc",
            authDomain: "pro42good-me.firebaseapp.com",
            projectId: "pro42good-me",
            appId: "1:699879008925:web:b06dd702ceeeb8afee4274",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const emailEl = document.getElementById("email");
        const passwordEl = document.getElementById("password");
        const emailSignInBtn = document.getElementById("emailSignInBtn");
        const emailSignUpBtn = document.getElementById("emailSignUpBtn");
        const googleSignInBtn = document.getElementById("googleSignInBtn");
        const signOutBtn = document.getElementById("signOutBtn");
        const errorEl = document.getElementById("error");
        const postLogin = document.getElementById("post-login");

        function setError(message) {
            errorEl.textContent = message || "";
        }

        function requireInputs() {
            const email = emailEl.value.trim();
            const password = passwordEl.value;
            if (!email) throw new Error("Enter your email.");
            if (!password || password.length < 6) throw new Error("Enter a password (min 6 chars).");
            return { email, password };
        }

        function setAuthenticatedUI(isAuthed) {
            postLogin.hidden = !isAuthed;
            signOutBtn.hidden = !isAuthed;
        }

        onAuthStateChanged(auth, (user) => {
            setError("");
            setAuthenticatedUI(!!user);
        });

        emailSignInBtn.addEventListener("click", async () => {
            setError("");
            try {
                const { email, password } = requireInputs();
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                setError(userFriendlyError(err));
            }
        });

        emailSignUpBtn.addEventListener("click", async () => {
            setError("");
            try {
                const { email, password } = requireInputs();
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (err) {
                setError(userFriendlyError(err));
            }
        });

        googleSignInBtn.addEventListener("click", async () => {
            setError("");
            try {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({ prompt: "select_account" });
                await signInWithPopup(auth, provider);
            } catch (err) {
                setError(userFriendlyError(err));
            }
        });

        signOutBtn.addEventListener("click", async () => {
            setError("");
            try {
                await signOut(auth);
            } catch {
                setError("Sign out failed. Try again.");
            }
        });

        document.getElementById("email-form").addEventListener("submit", (e) => e.preventDefault());

        function userFriendlyError(err) {
            if (!err || !err.code) return "An error occurred. Try again.";
            const code = String(err.code);
            if (code.includes("invalid-email")) return "Invalid email address.";
            if (code.includes("user-disabled")) return "This account is disabled.";
            if (code.includes("user-not-found")) return "No account found for this email.";
            if (code.includes("wrong-password")) return "Incorrect password.";
            if (code.includes("email-already-in-use")) return "Email already in use.";
            if (code.includes("weak-password")) return "Password is too weak.";
            if (code.includes("popup-closed-by-user")) return "Sign-in was canceled.";
            if (code.includes("popup-blocked")) return "Popup blocked. Allow popups and try again.";
            return "Authentication error. Try again.";
        }
    </script>
</body>
</html>
